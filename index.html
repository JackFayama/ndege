<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NovaFX</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-sm text-gray-900">
  <div class="fixed top-0 left-0 right-0 z-50 bg-gray-100">
    <div class="p-4">
      <div class="text-2xl font-bold text-black">NovaFX</div>
    </div>
  </div>

  <div id="pageContent" class="pt-[80px] pb-[80px]"></div>

  <div class="fixed bottom-0 left-0 right-0 z-50 bg-gray-100 flex justify-around py-3 rounded-t-2xl border-t">
    <button onclick="loadPage('home')" id="tab-home" class="tab-btn flex flex-col items-center text-green-400">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" stroke="currentColor" fill="none" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      <span>Home</span>
    </button>
    <button onclick="loadPage('trades')" id="tab-trades" class="tab-btn flex flex-col items-center text-black">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" stroke="currentColor" fill="none" stroke-width="2"><path d="M12 20v-6M6 20V10M18 20V4"/></svg>
      <span>Trades</span>
    </button>
    <button onclick="loadPage('wallet')" id="tab-wallet" class="tab-btn flex flex-col items-center text-black">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" stroke="currentColor" fill="none" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M7 15h0M2 9.5h20"/></svg>
      <span>Wallet</span>
    </button>
    <button onclick="loadPage('user')" id="tab-user" class="tab-btn flex flex-col items-center text-black">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5.52 19c.64-2.2 1.84-3 3.22-3h6.52c1.38 0 2.58.8 3.22 3"/><circle cx="12" cy="10" r="3"/><circle cx="12" cy="12" r="10"/></svg>
      <span>User</span>
    </button>
  </div>

  <div id="tradeModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-2xl w-[90%] max-w-sm space-y-4">
      <h2 class="text-lg font-semibold" id="tradeModalTitle">Trade</h2>
      <p id="tradeSymbol" class="font-semibold text-center"></p>
      <input type="number" id="lotSize" class="w-full border p-2 rounded-md" placeholder="Lot Size" />
      <input type="number" id="tradeAmount" class="w-full border p-2 rounded-md" placeholder="Amount (KSh)" />
      <input type="number" id="takeProfit" class="w-full border p-2 rounded-md" placeholder="Take Profit Price" />
      <input type="number" id="stopLoss" class="w-full border p-2 rounded-md" placeholder="Stop Loss Price" />
      <div class="flex justify-end gap-2">
        <button onclick="closeTradeModal()" class="px-4 py-2">Cancel</button>
        <button onclick="confirmTrade()" class="bg-blue-600 text-white px-4 py-2 rounded">Submit</button>
      </div>
    </div>
  </div>

  <script>
    const prices = {};
    const socket = new WebSocket("wss://ws.finnhub.io?token=d17ug69r01qteuvq4ga0d17ug69r01qteuvq4gag");
    const format = val => "KSh" + parseFloat(val).toLocaleString("en-KE", { minimumFractionDigits: 2 });

    function confirmTrade() {
      const amount = parseFloat(document.getElementById("tradeAmount").value || 0);
      const lotSize = parseFloat(document.getElementById("lotSize").value || 1);
      const takeProfit = parseFloat(document.getElementById("takeProfit").value);
      const stopLoss = parseFloat(document.getElementById("stopLoss").value);
      const trades = JSON.parse(localStorage.getItem("trades") || "[]");
      trades.push({ 
        symbol: tradeSymbol, 
        type: tradeAction, 
        amount, 
        lotSize, 
        takeProfit, 
        stopLoss,
        active: true
      });
      localStorage.setItem("trades", JSON.stringify(trades));
      closeTradeModal();
      loadPage("trades");
    }

    function closeTradeModal() {
      document.getElementById("tradeModal").classList.add("hidden");
      document.getElementById("tradeModal").classList.remove("flex");
    }

    function simulateTrades(livePrices) {
      let trades = JSON.parse(localStorage.getItem("trades") || "[]");
      let updated = false;
      let balance = parseFloat(localStorage.getItem("balance") || 5000);
      trades = trades.map(t => {
        if (!t.active) return t;
        const price = livePrices[t.symbol.replace("_", "")]?.last;
        if (!price) return t;

        if (t.type === 'Buy' && price >= t.takeProfit) {
          balance += t.amount;
          t.active = false;
          updated = true;
        } else if (t.type === 'Buy' && price <= t.stopLoss) {
          balance -= t.amount;
          t.active = false;
          updated = true;
        } else if (t.type === 'Sell' && price <= t.takeProfit) {
          balance += t.amount;
          t.active = false;
          updated = true;
        } else if (t.type === 'Sell' && price >= t.stopLoss) {
          balance -= t.amount;
          t.active = false;
          updated = true;
        }
        return t;
      });
      if (updated) {
        localStorage.setItem("balance", balance);
        localStorage.setItem("equity", balance + 100);
        localStorage.setItem("trades", JSON.stringify(trades));
        loadPage("wallet");
        loadPage("trades");
        loadPage("home");
      }
    }

    socket.addEventListener("message", event => {
      const data = JSON.parse(event.data);
      if (data.type === "trade") {
        const livePrices = {};
        data.data.forEach(trade => {
          const full = trade.s.replace("OANDA:", "");
          const id = full.replace("_", "");
          const price = parseFloat(trade.p).toFixed(5);
          if (!prices[id]) prices[id] = { last: price };
          prices[id].last = price;
          livePrices[id] = { last: parseFloat(price) };
        });
        simulateTrades(livePrices);
      }
    });
  </script>
</body>
</html>
